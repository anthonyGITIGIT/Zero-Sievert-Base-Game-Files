name: Build manifest
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'Zero-Sievert-gml-files/**'
      - 'Zero-Sievert-json-files/**'
      - 'Modding-Documentation/**'
      - '.github/workflows/manifest.yml'

permissions:
  contents: write

jobs:
  manifest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build manifest from working tree (no jq)
        run: |
          set -euo pipefail
          echo "path,type,size_bytes" > manifest.csv

          # Collect matching files from the repo working tree
          git ls-files \
          | grep -E '^(Zero-Sievert-gml-files/.*\.gml|Zero-Sievert-json-files/.*\.json|Modding-Documentation/.*\.html)$' \
          | awk '{
              type="unknown";
              if ($0 ~ /\.gml$/)  type="gml";
              else if ($0 ~ /\.json$/) type="json";
              else if ($0 ~ /\.html$/) type="html";
              printf "%s,%s,%s\n", $0, type, ""
            }' >> manifest.csv

          echo "Wrote $(( $(wc -l < manifest.csv) - 1 )) entries to manifest.csv"

      - name: Commit manifest.csv
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update manifest.csv"
          file_pattern: "manifest.csv"
